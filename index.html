  for (const s of sorted) {
      const card = document.createElement('div');
      card.className = 'card';

      const imgEl = document.createElement('img');
      imgEl.className = 'poster';
      imgEl.src = s.poster || '';
      imgEl.alt = s.title;
      imgEl.onerror = () => { imgEl.style.display = 'none'; };

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = s.title;

      const badge = s.next ? document.createElement('span') : null;
      if (badge){
        badge.className = 'notify';
        badge.textContent = s.next;
        title.appendChild(badge);
      }

      card.appendChild(imgEl);
      card.appendChild(title);

      card.onclick = () => openModal(s);

      grid.appendChild(card);
    }
  }

  function openModal(show){
    mPoster.src = show.poster || '';
    mTitle.textContent = show.title;
    mInfo.textContent = `${show.year || ''} • ${show.type || ''}`;
    mCurr.value = show.curr || 0;
    mTotal.textContent = `de ${show.total || 0}`;
    const percent = show.total ? (show.curr || 0)/show.total*100 : 0;
    mBar.style.width = percent+'%';

    mMarkDone.textContent = (show.curr >= show.total) ? 'Desmarcar terminada' : 'Marcar como terminada';

    mb.style.display='flex';

    mMinus.onclick = async ()=>{ show.curr = Math.max(0,(show.curr||0)-1); await save(shows); render(); openModal(show); };
    mPlus.onclick = async ()=>{ show.curr = Math.min(show.total||(show.curr||0)+1,(show.curr||0)+1); await save(shows); render(); openModal(show); };
    mCurr.onchange = async ()=>{ show.curr = Number(mCurr.value); await save(shows); render(); openModal(show); };
    mMarkDone.onclick = async ()=>{
      if((show.curr||0) >= (show.total||0)){ show.curr = 0; } else { show.curr = show.total || 0; }
      await save(shows); render(); openModal(show);
    };
    mReset.onclick = async ()=>{ show.curr = 0; await save(shows); render(); openModal(show); };
    mDelete.onclick = async ()=>{ shows = shows.filter(s=>s.id!==show.id); await deleteFromDB(show.id); render(); mb.style.display='none'; };
    mClose.onclick = ()=>{ mb.style.display='none'; };
  }

  toggleFilterBtn.onclick = ()=>{ hideDone=!hideDone; setHideDone(hideDone); updateFilterButton(); render(); };
  clearBtn.onclick = async ()=>{ shows=[]; const snapshot = await getDocs(coll); for(const d of snapshot.docs){ await deleteFromDB(d.id); } render(); };

  updateFilterButton();
  render();

  // ===== BUSQUEDA TVMAZE =====
  async function search(query){
    if(!query) return drop.style.display='none';
    const res = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    results = data.map(d=>{
      const s = d.show;
      return {id:String(s.id), title:s.name, poster:s.image?.medium||'', total:s._embedded?.episodes?.length||0, curr:0, year: s.premiered?.split('-')[0]||'', type: s.type};
    });
    activeIndex=-1;
    renderDropdown();
  }

  function renderDropdown(){
    drop.innerHTML='';
    if(!results.length){ drop.style.display='none'; return; }
    results.forEach((r,i)=>{
      const el = document.createElement('div');
      el.className='opt'+(i===activeIndex?' active':'');
      el.innerHTML=`<div class="mini"><img src="${r.poster}" onerror="this.style.display='none'"></div>
                      <div><div class="t">${r.title}</div><div class="s">${r.year}</div></div>`;
      el.onclick=async ()=>{
        if(shows.find(s=>s.id===r.id)){ alert('Ya está en tu lista'); return; }
        shows.unshift({...r});
        await save(shows);
        render();
        drop.style.display='none';
        q.value='';
      };
      drop.appendChild(el);
    });
    drop.style.display='block';
  }

  let debounceTimer=null;
  q.oninput=()=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>search(q.value),300); };
  q.onkeydown=(e)=>{
    if(!results.length) return;
    if(e.key==='ArrowDown'){ activeIndex=(activeIndex+1)%results.length; renderDropdown(); e.preventDefault(); }
    if(e.key==='ArrowUp'){ activeIndex=(activeIndex-1+results.length)%results.length; renderDropdown(); e.preventDefault(); }
    if(e.key==='Enter' && activeIndex>=0){ results[activeIndex].onclick?.(); e.preventDefault(); }
  };

</script>
</body>
</html>
