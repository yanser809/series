<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Series Watchlist</title>

<style>
  /* ===== TODO TU CSS ORIGINAL ===== */
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');
  :root{
    --bg:#0b0f19; --panel:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#e50914; --accent-2:#b81d24; --ok:#22c55e; --warn:#f59e0b; --line:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 400px at 50% -80px,rgba(229,9,20,.18),transparent 60%), var(--bg);
    color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,rgba(11,15,25,.96),rgba(11,15,25,.75));
    border-bottom:1px solid var(--line);
    backdrop-filter:blur(10px);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:20px 16px}
  .hero{ display:flex; flex-direction:column; gap:14px; align-items:center; justify-content:center; padding:18px 0 8px 0; }
  /* TVMaze‚Äëstyle header layout */
  .hero{ display:flex; flex-direction:row; align-items:center; justify-content:space-between; padding:18px 0 8px 0; }
  /* Title styling similar to TVMaze */
  .hero .badges{ margin-left:0; margin-right:12px; }

  .header-logo {
    width: 120px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .header-logo:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  }
  .header-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3.5rem; /* Tama√±o grande y audaz */
    color: var(--accent); /* Rojo Netflix */
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.7);
    margin: 0;
  }
  .hero .row{ margin-left:auto; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:10px; }
  input,button{ padding:12px 14px; border-radius:10px; border:1px solid var(--line); background:#0c1222; color:var(--text); }
  button{ cursor:pointer; transition:.2s ease }
  .btn-ghost{ background:transparent }

  /* Buscador grande */
  .searchbox{
    position:relative; flex:1;
    min-width:300px;
    max-width:600px;
  }
  .searchbox input{
    width:100%;
    height:40px;
    font-size:1rem;
    padding:10px 12px;
    border-radius:12px;
  }

  /* Dropdown con mini-p√≥ster, highlight y teclado */
  .dropdown{
    position:absolute; top:110%; left:0; right:0; background:#0b1220; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 14px 40px rgba(0,0,0,.45); max-height:480px; overflow:auto; display:none; padding:6px;
    z-index:20;
  }
  .opt{
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 10px 12px;
    border-bottom: 1px solid #111827;
    cursor: pointer;
    border-radius: 12px;
    transition: background .18s, box-shadow .18s, transform .18s;
    box-shadow: 0 2px 8px rgba(0,0,0,.10);
  }
  .opt:hover{
    background: #181f2e;
    box-shadow: 0 8px 24px rgba(229,9,20,.10), 0 2px 8px rgba(0,0,0,.18);
    transform: scale(1.03);
  }
  .opt.active{
    outline: 2px solid rgba(229,9,20,.5);
    background: #181f2e;
  }
  .mini{
    width: 54px;
    height: 80px;
    border-radius: 10px;
    border: 2px solid #222;
    background: #111827;
    object-fit: cover;
    display: block;
    box-shadow: 0 4px 16px rgba(0,0,0,.18);
    transition: transform .18s, box-shadow .18s;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
  .mini.placeholder{
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .75rem;
    color: #666;
    background: linear-gradient(180deg,#0f172a,#0b1220);
  }
  .opt:hover .mini{
    transform: scale(1.08);
    box-shadow: 0 12px 32px rgba(229,9,20,.18), 0 4px 16px rgba(0,0,0,.22);
  }
  .opt .info{
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
  }
  .opt .t{
    font-weight: 700;
    font-size: 1.08rem;
    line-height: 1.25;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
    max-width: 220px;
  }
  .opt .s{
    color: var(--muted);
    font-size: .95rem;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
  }
  .opt mark{
    background: rgba(229,9,20,.28);
    color: #fff;
    padding: 0 .1em;
    border-radius: 3px;
  }

  /* Grid */
  .section{ max-width:1200px; margin:18px auto; padding:0 16px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); gap:16px }
  .card{
    position:relative; background:var(--card); border:1px solid var(--line);
    border-radius:12px; overflow:hidden; cursor:pointer;
    transform:translateZ(0); transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .card:hover{ transform:translateY(-3px) scale(1.03); box-shadow:0 16px 36px rgba(0,0,0,.35); filter:brightness(1.03); }
  .poster{ width:100%; aspect-ratio:2/3; object-fit:cover; background:#101623; display:block }
  /* Override poster size to 210x295px */
  .poster{ width:100%; height:auto; }
  .title{
    padding: 12px 10px 8px;
    font-family: 'Cinzel', serif;
    text-align: center;
    font-weight: 700;
    font-size: 1.05rem;
    line-height: 1.3;
    display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden;
    letter-spacing: .03rem;
  }

  .progress{ position:absolute; top:8px; right:8px; background:rgba(0,0,0,.65); border:1px solid var(--line); padding:3px 8px; border-radius:999px; font-size:.85rem; color:#fff }
  .bar{ height:4px; background:#1f2937 }
  .bar-in{ height:100%; background:linear-gradient(90deg,#22c55e,#f59e0b); width:0% }
  .empty{ border:1px dashed var(--line); border-radius:12px; padding:24px; color:var(--muted); text-align:center }

  /* Badge de siguiente episodio */
  .notify{
    display:inline-block; margin-left:8px; vertical-align:middle;
    padding:2px 8px; border-radius:999px; font-size:.78rem; font-weight:700; letter-spacing:.02rem;
    border:1px solid #14532d; color:#bbf7d0; background:rgba(34,197,94,.22);
  }
  .notify.upcoming{
    border-color:#075985; color:#7dd3fc; background:rgba(56,189,248,.22);
  }

  /* Estado VIENDO/TERMINADA */
  .state{
    position:absolute; top:8px; left:8px;
    padding:3px 8px; border-radius:999px; font-size:.78rem; font-weight:800; letter-spacing:.02rem;
    border:1px solid var(--line);
    background:rgba(0,0,0,.65); color:#fff;
  }
  .state.done{
    border-color:#14532d; background:rgba(34,197,94,.18); color:#bbf7d0;
  }

  /* ===== Nuevo dise√±o de modal compacto (modificado) ===== */
  .modal-back {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    display: none; align-items: center; justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
  }
  .modal {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    width: 420px;
    padding: 20px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.45);
    display: flex; flex-direction: column; gap: 14px;
    animation: popIn .25s ease;
  }
  @keyframes popIn {
    from {transform: scale(.85); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
  }
  .modal .top {
    display: flex; align-items: flex-start; gap: 14px;
  }
  .modal img {
    width: 100px; height: 150px;
    object-fit: cover; border-radius: 10px; border:1px solid var(--line);
  }
  .modal .meta h3 {
    margin: 0; font-size: 1.05rem;
  }
  .modal .meta .muted {
    color: var(--muted); font-size: .9rem; margin-bottom: 6px;
  }
  .modal .controls {
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  }
  .modal input.num {
    width: 50px; text-align: center;
  }
  .modal .bottom {
    display: flex; flex-direction: column; gap: 10px;
  }
  .modal button { border-radius: 8px; padding:8px 12px; }
  .modal .modern-controls { justify-content: center; margin-top: 10px; }
  .modal .modern-controls button { font-size: 1rem; background: #222; color: #fbbf24; border: 1px solid var(--line); border-radius: 6px; padding: 4px 8px; }
  .modal .ep-num { font-weight: bold; font-size: .95rem; color: #fff; background: rgba(0,0,0,0.13); border-radius: 6px; padding: 4px 8px; margin: 0 2px; }
  .modal .next-ep-info { margin-top: 8px; font-size: 1.05rem; font-weight: bold; padding: 7px 12px; border-radius: 8px; text-align: center; }
  .modal .next-ep-info.upcoming { color: #38bdf8; background: rgba(56, 189, 248, 0.18); }
  .modal .next-ep-info.available { color: var(--muted); background: rgba(156,163,175,0.08); }
  .modal select#mSeasonSelect {
    background: rgba(34,197,94,0.18); color: #22c55e;
    font-weight: bold; font-size: 1rem;
    border: 1px solid var(--line); border-radius: 8px;
    padding: 8px 12px;
    -webkit-appearance: none; appearance: none;
    cursor: pointer;
  }
  .modal .bottom .controls { justify-content: center; display: flex; gap: 16px; }


  .card{display:flex;flex-direction:column;align-items:center;gap:8px;}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="hero">
      <div style="display: flex; align-items: center; gap: 24px;">
        <img class="header-logo" src="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjRjFGNEZBIiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTIxLDNIM0EyLDIsMCwwLDAsMSw1VjE5YTIsMiwwLDAsMCwyLDJIMjFhMiwyLDAsMCwwLDItMlY1YTIsMiwwLDAsMC0yLTJaTTUsNWgyVjdoLTJaTTUsOWgydjJoLTJaTTUsMTRoMnYyaC0yWk0xOSw1aDJWN2gtMlptMCw1aDJWN2gtMlptMCw0aDJWN2gtMlptLTYsNWgtNWEyLDIsMCwwLDEtMi0yVjEwYTIsMiwwLDAsMSwyLTJoNWEyLDIsMCwwLDEsMiwyVjE3YTIsMiwwLDAsMS0yLDJaIiBzdHlsZT0iZmlsbDojZTVlN2ViOyIvPjxwYXRoIGQ9Ik0xMSwxMHY1YTQuMzUsNC4zNSwwLDAsMCwzLjUtMi41WiIgc3R5bGU9ImZpbGw6I2U1ZTdlYjsiLz48L3N2Zz4=" alt="Logo de la web">
        <h1 class="header-title">SERIES FAVORITAS</h1>
      </div>
      <div class="row">
        <div class="searchbox">
          <input id="q" type="text" placeholder="Buscar series‚Ä¶ (ej. Dark, Friends, The Office)" autocomplete="off"/>
          <div id="drop" class="dropdown"></div>
        </div>
        <button id="toggleFilter" class="btn-ghost">Filtrar terminadas</button>
      </div>
    </div>
  </div>
</header>

<main class="section">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No tienes series a√∫n. Busca arriba y agr√©galas üçø</div>
</main>

<div id="mb" class="modal-back">
  <div class="modal">
    <div class="top">
      <img id="mPoster" src="" alt="">
      <div class="meta">
        <h3 id="mTitle"></h3>
        <div class="muted" id="mInfo"></div> <!-- Year, Type -->
        <div id="mNextEpInfo" class="next-ep-info"></div>
        <div class="controls modern-controls">
            <button id="mPrevEp">‚ü®</button>
            <span id="mEpNum" class="ep-num"></span>
            <button id="mNextEp">‚ü©</button>
        </div>
      </div>
    </div>
    <div class="bottom">
      <div class="controls">
        <button id="mMarkDone" class="btn-ghost" style="border:1px solid var(--line)">Marcar como terminada</button>
        <select id="mSeasonSelect" style="display:none;"></select>
      </div>
      <div class="controls">
        <button id="mDelete" class="btn-ghost" style="color:#fca5a5;border-color:#7f1d1d">Eliminar</button>
        <button id="mClose" class="btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ===== FIREBASE INTEGRACI√ìN =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAQpxEWjV_J3AfyBDR4EWEmSrgFjW16z9k",
    authDomain: "series-80d83.firebaseapp.com",
    projectId: "series-80d83",
    storageBucket: "series-80d83.firebasestorage.app",
    messagingSenderId: "959880535049",
    appId: "1:959880535049:web:148625072c52de0acbacd8",
    measurementId: "G-7495M6CRN7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const coll = collection(db, "series_watchlist");

  /* ===== STORAGE FIREBASE ===== */
  const load = async () => {
    const snapshot = await getDocs(coll);
    const data = snapshot.docs.map(d => d.data());
    return data.sort((a,b)=>b.id.localeCompare(a.id)); // orden descendente por id
  };
  const saveShow = async (show) => {
    await setDoc(doc(coll, show.id), show);
  };
  const saveAllShows = async (shows) => { for(const s of shows){ await setDoc(doc(coll, s.id), s); } };

  const deleteFromDB = async (id) => {
    await deleteDoc(doc(coll,id));
  };
  const getHideDone = () => JSON.parse(localStorage.getItem('series_hideDone') || 'false');
  const setHideDone = (v) => localStorage.setItem('series_hideDone', JSON.stringify(!!v));

  /* ===== RESTO DEL JS ORIGINAL ===== */
  let shows = await load();
  let results = [];
  let activeIndex = -1;
  let currentShow = null; // Para saber qu√© serie est√° en el modal
  let hideDone = getHideDone();

  const q = document.getElementById('q');
  const drop = document.getElementById('drop');
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const toggleFilterBtn = document.getElementById('toggleFilter');

  const mb = document.getElementById('mb');
  const mPoster = document.getElementById('mPoster');
  const mTitle  = document.getElementById('mTitle');
  const mInfo = document.getElementById('mInfo');
  const mNextEpInfo = document.getElementById('mNextEpInfo');
  const mPrevEp = document.getElementById('mPrevEp');
  const mEpNum = document.getElementById('mEpNum');
  const mNextEp = document.getElementById('mNextEp');
  const mMarkDone = document.getElementById('mMarkDone');
  const mSeasonSelect = document.getElementById('mSeasonSelect');
  const mDelete = document.getElementById('mDelete');
  const mClose  = document.getElementById('mClose');

  function updateFilterButton(){ toggleFilterBtn.textContent = hideDone ? 'Mostrar terminadas' : 'Filtrar terminadas'; }

  async function render() {
    grid.innerHTML = '';
    if (shows.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    const filtered = hideDone
      ? shows.filter(s => !((s.total || 0) > 0 && (s.curr || 0) >= s.total))
      : [...shows];

    const sorted = [...filtered].sort((a, b) => {
      const aDone = (a.total || 0) > 0 && (a.curr || 0) >= a.total;
      const bDone = (b.total || 0) > 0 && (b.curr || 0) >= b.total;
      if (aDone === bDone) return 0;
      return aDone ? 1 : -1;
    });

    for (const s of sorted) {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.flexDirection = 'column'; // Asegurar direcci√≥n vertical

      // Solo imagen del p√≥ster, sin enlace
      const imgEl = document.createElement('img');
      imgEl.className = 'poster';
      imgEl.src = s.poster || '';
      imgEl.alt = s.title;
      imgEl.onerror = () => { imgEl.style.display = 'none'; };

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = s.title;

      // Indicador de estado arriba a la izquierda
      const stateDiv = document.createElement('div');
      stateDiv.className = 'state';
      const isDone = (s.total || 0) > 0 && (s.curr || 0) >= s.total;
      if (isDone) {
        stateDiv.textContent = 'Terminada';
        stateDiv.classList.add('done');
      } else {
        stateDiv.textContent = 'Viendo';
      }
      imgEl.parentNode?.insertBefore(stateDiv, imgEl); // No es visible con el nuevo layout, pero se mantiene la l√≥gica

      // Estrella y votos arriba a la derecha
      const votesBox = document.createElement('div');
      votesBox.style.position = 'absolute';
      votesBox.style.top = '8px';
      votesBox.style.right = '8px';
      votesBox.style.zIndex = '2';
      votesBox.style.background = 'rgba(0,0,0,0.65)';
      votesBox.style.border = '1px solid var(--line)';
      votesBox.style.borderRadius = '999px';
      votesBox.style.padding = '3px 10px';
      votesBox.style.fontSize = '1.08rem';
      votesBox.style.fontWeight = 'bold';
      votesBox.style.color = '#fbbf24';
      votesBox.style.display = 'flex';
      votesBox.style.alignItems = 'center';
      votesBox.innerHTML = `<span style="font-size:1.2em;">‚òÖ</span> <span style="margin-left:4px;">${s.votes !== undefined ? s.votes : '0'}</span>`;
      
      // Bloque de estado del pr√≥ximo episodio debajo del p√≥ster
      let nextEpNum = (s.curr || 0) + 1;
      let nextEpDate = null;
      let nextInfo = '';
      let nextColor = '';
      let nextBg = '';
      if (s.episodes && Array.isArray(s.episodes) && s.episodes.length >= nextEpNum) {
        const ep = s.episodes[nextEpNum - 1];
        nextEpDate = ep?.airdate;
      }
      if (nextEpDate) {
        const today = new Date();
        today.setHours(0,0,0,0); // solo fecha
        const airDate = new Date(nextEpDate);
        airDate.setHours(0,0,0,0);
        if (airDate < today) {
          nextInfo = `Episodio ${nextEpNum}: Disponible`;
          nextColor = '#22c55e'; // verde
          nextBg = 'rgba(34,197,94,0.18)';
        } else {
          nextInfo = `Episodio ${nextEpNum}: ${nextEpDate}`;
          nextColor = '#38bdf8'; // azul cian
          nextBg = 'rgba(56, 189, 248, 0.18)';
        }
      } else {
        nextInfo = `Episodio ${nextEpNum}: No disponible`;
        nextColor = 'var(--muted)';
        nextBg = 'rgba(156,163,175,0.08)';
      }
      const nextBlock = document.createElement('div');
      nextBlock.style.background = nextBg;
      nextBlock.style.color = nextColor;
      nextBlock.style.fontWeight = 'bold';
      nextBlock.style.fontSize = '0.9rem';
      nextBlock.style.padding = '8px 10px';
      nextBlock.style.textAlign = 'center';
      nextBlock.style.width = '100%';
      nextBlock.textContent = nextInfo;

      // --- CORRECCI√ìN ---
      // Crear el contenedor de la imagen y a√±adir los elementos en el orden correcto.
      const imageContainer = document.createElement('div');
      imageContainer.style.position = 'relative';
      imageContainer.style.width = '100%';
      imageContainer.append(imgEl, votesBox, stateDiv); // A√±adir primero la imagen, luego los indicadores superpuestos.
      card.append(imageContainer, title, nextBlock); // A√±adir todo a la tarjeta principal.

      card.onclick = () => openModal(s);

      grid.appendChild(card);
    }
  }

  function openModal(show){
    currentShow = show;
    mPoster.src = show.poster || '';
    mTitle.textContent = show.title;
    mInfo.textContent = `${show.year || ''} ‚Ä¢ ${show.type || ''}`;

    updateModalContent(show);
    mb.style.display='flex';
  }

  function getNextEpisodeInfo(show) {
      const nextEpNum = (show.curr || 0) + 1;
      if (!show.episodes || !Array.isArray(show.episodes) || show.episodes.length < nextEpNum) {
          return { text: `Pr√≥ximo episodio (${nextEpNum}): No disponible`, isUpcoming: false };
      }
      const nextEp = show.episodes[nextEpNum - 1];
      const airDate = nextEp?.airdate ? new Date(nextEp.airdate) : null;
      if (!airDate) {
          return { text: `Pr√≥ximo episodio (${nextEpNum}): No disponible`, isUpcoming: false };
      }
      const today = new Date();
      today.setHours(0,0,0,0);
      airDate.setHours(0,0,0,0);

      if (airDate > today) {
          return { text: `Pr√≥ximo episodio (${nextEpNum}): ${nextEp.airdate}`, isUpcoming: true };
      }
      return { text: `Pr√≥ximo episodio (${nextEpNum}): Disponible`, isUpcoming: false };
  }

  function updateModalContent(show) {
    const { text, isUpcoming } = getNextEpisodeInfo(show);
    mNextEpInfo.textContent = text;
    mNextEpInfo.className = 'next-ep-info ' + (isUpcoming ? 'upcoming' : 'available');

    // --- L√≥gica para mostrar episodio por temporada ---
    if (show.episodes && show.curr > 0 && show.episodes[show.curr - 1]) {
      const currentEp = show.episodes[show.curr - 1];
      const currentSeasonNum = currentEp.season;
      const epNumInSeason = currentEp.number;

      const episodesInSeason = show.episodes.filter(ep => ep.season === currentSeasonNum);
      const totalEpsInSeason = episodesInSeason.length;

      mEpNum.textContent = `Episodio ${epNumInSeason} de ${totalEpsInSeason}`;
    } else {
      // Fallback si no hay datos de episodios
      mEpNum.textContent = `Episodio ${show.curr || 0} de ${show.total || '?'}`;
    }

    const isDone = (show.total || 0) > 0 && (show.curr || 0) >= show.total;
    mMarkDone.textContent = isDone ? 'Desmarcar terminada' : 'Marcar como terminada';

    // --- L√≥gica para el selector de temporada ---
    mSeasonSelect.innerHTML = '';
    if (show.episodes && Array.isArray(show.episodes) && show.episodes.length > 0) {
      const seasons = [...new Set(show.episodes.map(ep => ep.season))].sort((a,b) => a - b);
      let currentSeason = -1;
      if (show.curr > 0 && show.episodes[show.curr - 1]) {
        currentSeason = show.episodes[show.curr - 1].season;
      }

      seasons.forEach(seasonNum => {
        const option = document.createElement('option');
        option.value = seasonNum;
        option.textContent = `Temporada ${seasonNum}`;
        if (seasonNum === currentSeason) {
          option.selected = true;
        }
        mSeasonSelect.appendChild(option);
      });

      mSeasonSelect.style.display = 'inline-block';
    } else {
      mSeasonSelect.style.display = 'none';
    }
  }

  async function updateShow(updateFn) {
    if (!currentShow) return;
    updateFn(currentShow);
    await saveShow(currentShow);
    updateModalContent(currentShow);
    render();
  }

  mSeasonSelect.onchange = () => {
    if (!currentShow || !currentShow.episodes) return;
    const selectedSeason = parseInt(mSeasonSelect.value, 10);
    // Encontrar el primer episodio de la temporada seleccionada
    const firstEpisodeOfSeason = currentShow.episodes.find(ep => ep.season === selectedSeason);
    if (firstEpisodeOfSeason) {
      // El n√∫mero de episodio es `ep.number` en la API, pero nuestro `curr` es un √≠ndice basado en 1
      // Buscamos el √≠ndice del primer episodio de la temporada en la lista completa
      const episodeIndex = currentShow.episodes.findIndex(ep => ep.id === firstEpisodeOfSeason.id);
      updateShow(s => { s.curr = episodeIndex + 1; });
    }
  };

  mPrevEp.onclick = () => updateShow(s => { s.curr = Math.max(0, (s.curr || 0) - 1); });
  mNextEp.onclick = () => updateShow(s => { s.curr = Math.min(s.total || Infinity, (s.curr || 0) + 1); });
  mMarkDone.onclick = () => updateShow(s => {
    const isDone = (s.total || 0) > 0 && (s.curr || 0) >= s.total;
    s.curr = isDone ? 0 : (s.total || 0);
  });
  mDelete.onclick = async () => {
    if (!currentShow) return;
    shows = shows.filter(s => s.id !== currentShow.id);
    await deleteFromDB(currentShow.id);
    render();
    mb.style.display = 'none';
  };
  mClose.onclick = () => { mb.style.display = 'none'; };

  toggleFilterBtn.onclick = ()=>{ hideDone=!hideDone; setHideDone(hideDone); updateFilterButton(); render(); };

  updateFilterButton();
  render();

async function search(query){
    if(!query) return drop.style.display='none';
    const res = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    results = await Promise.all(data.map(async d => {
      const s = d.show;
      let nextEp = null;
      let nextDate = null;
      let episodes = [];
      let votes = s.rating?.average !== null && s.rating?.average !== undefined ? s.rating.average : 0;
      try {
        const epRes = await fetch(`https://api.tvmaze.com/shows/${s.id}/episodes`);
        episodes = await epRes.json();
        const today = new Date();
        const upcoming = episodes.find(ep => ep.airdate && new Date(ep.airdate) > today);
        if (upcoming) {
          nextEp = upcoming.number;
          nextDate = upcoming.airdate;
        }
      } catch {}
      return {
        id: String(s.id),
        title: s.name,
        poster: s.image?.original || s.image?.medium || '',
        total: episodes.length || 0,
        curr: 0,
        year: s.premiered?.split('-')[0] || '',
        type: s.type,
        nextEp,
        nextDate,
        votes,
        episodes
      };
    }));
    activeIndex=-1;
    renderDropdown();
}
  

function renderDropdown(){
    drop.innerHTML='';
    if(!results.length){ drop.style.display='none'; return; }
    results.forEach((r,i)=>{
      const el = document.createElement('div');
      el.className = 'opt' + (i === activeIndex ? ' active' : '');
      el.innerHTML = `
        <div class="mini"><img src="${r.poster}" style="width:100%;height:100%;border-radius:inherit;object-fit:cover;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;" onerror="this.style.display='none'"></div>
        <div class="info">
          <div class="t">${r.title}</div>
          <div class="s">${r.year}</div>
        </div>
      `;
      el.onclick = async () => {
        if (shows.find(s => s.id === r.id)) { alert('Ya est√° en tu lista'); return; }
        const newShow = { ...r };
        await saveShow(newShow); // Guardar solo la nueva serie
        shows.unshift(newShow);
        render();
        drop.style.display = 'none';
        q.value = '';
      };
      drop.appendChild(el);
    });
    drop.style.display = 'block';
  }

  let debounceTimer=null;
  q.oninput=()=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>search(q.value),300); };
  q.onkeydown=(e)=>{
    if(!results.length) return;
    if(e.key==='ArrowDown'){ activeIndex=(activeIndex+1)%results.length; renderDropdown(); e.preventDefault(); }
    if(e.key==='ArrowUp'){ activeIndex=(activeIndex-1+results.length)%results.length; renderDropdown(); e.preventDefault(); }
    if(e.key==='Enter' && activeIndex>=0){ results[activeIndex].onclick?.(); e.preventDefault(); }
  };

</script>
</body>
</html>
