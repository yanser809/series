<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SERIES ‚Äî Watchlist</title>

<style>
  /* ===== TODO TU CSS ORIGINAL ===== */
  :root{
    --bg:#0b0f19; --panel:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#e50914; --accent-2:#b81d24; --ok:#22c55e; --warn:#f59e0b; --line:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 400px at 50% -80px,rgba(229,9,20,.18),transparent 60%), var(--bg);
    color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,rgba(11,15,25,.96),rgba(11,15,25,.75));
    border-bottom:1px solid var(--line);
    backdrop-filter:blur(10px);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:20px 16px}
  .hero{ display:flex; flex-direction:column; gap:14px; align-items:center; justify-content:center; padding:18px 0 8px 0; }
  .badges{ display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; transform:translateZ(0); }
  .badge{
    font-family:'Cinzel', serif; font-weight:900; letter-spacing:.2rem;
    font-size: clamp(1.6rem, 3vw, 2.2rem); line-height:1;
    color:#fff; padding:8px 18px; border-radius:10px; border:1px solid #4c0b0f;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    text-shadow:0 1px 2px rgba(0,0,0,.6);
    box-shadow: 0 6px 20px rgba(229,9,20,.18), inset 0 0 10px rgba(255,255,255,.06);
    transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .badge.alt{ background:linear-gradient(90deg,var(--accent-2),var(--accent)); }
  .badge:hover{ transform:translateY(-2px) scale(1.03); filter:brightness(1.06); box-shadow:0 16px 36px rgba(229,9,20,.25), inset 0 0 12px rgba(255,255,255,.08); }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:10px; }
  input,button{ padding:12px 14px; border-radius:10px; border:1px solid var(--line); background:#0c1222; color:var(--text); }
  button{ cursor:pointer; transition:.2s ease }
  .btn-ghost{ background:transparent }

  /* Buscador grande */
  .searchbox{
    position:relative; flex:1;
    min-width:400px;
    max-width:900px;
  }
  .searchbox input{
    width:100%;
    height:60px;
    font-size:1.2rem;
    padding:14px 18px;
    border-radius:12px;
  }

  /* Dropdown con mini-p√≥ster, highlight y teclado */
  .dropdown{
    position:absolute; top:110%; left:0; right:0; background:#0b1220; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 14px 40px rgba(0,0,0,.45); max-height:480px; overflow:auto; display:none; padding:6px;
  }
  .opt{
    display:grid; grid-template-columns:68px 1fr; gap:12px;
    padding:10px; border-bottom:1px solid #111827; align-items:center; cursor:pointer; border-radius:8px;
  }
  .opt:hover{ background:#0f172a }
  .opt.active{ outline:2px solid rgba(229,9,20,.5); background:#0f172a; }
  .mini{
    width:68px; height:102px; border-radius:8px; border:1px solid var(--line); background:#111827; object-fit:cover; display:block;
  }
  .mini.placeholder{
    display:flex; align-items:center; justify-content:center; font-size:.75rem; color:#666; background:linear-gradient(180deg,#0f172a,#0b1220);
  }
  .opt .t{
    font-weight:700; font-size:1.02rem; line-height:1.25; white-space:normal; word-break:break-word;
  }
  .opt .s{ color:var(--muted); font-size:.95rem; margin-top:2px; }
  .opt mark{
    background:rgba(229,9,20,.28);
    color:#fff;
    padding:0 .1em;
    border-radius:3px;
  }

  /* Grid */
  .section{ max-width:1200px; margin:18px auto; padding:0 16px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); gap:16px }
  .card{
    position:relative; background:var(--card); border:1px solid var(--line);
    border-radius:12px; overflow:hidden; cursor:pointer;
    transform:translateZ(0); transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .card:hover{ transform:translateY(-3px) scale(1.03); box-shadow:0 16px 36px rgba(0,0,0,.35); filter:brightness(1.03); }
  .poster{ width:100%; aspect-ratio:2/3; object-fit:cover; background:#101623; display:block }
  .title{
    position:absolute; left:8px; right:8px; bottom:8px;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,.88));
    padding:40px 10px 10px; border-radius:10px; color:#fff; font-weight:800;
    text-shadow:0 1px 2px rgba(0,0,0,.8); font-family:'Cinzel', serif; letter-spacing:.03rem; font-size:1rem; line-height:1.25;
    display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden;
  }
  .progress{ position:absolute; top:8px; right:8px; background:rgba(0,0,0,.65); border:1px solid var(--line); padding:3px 8px; border-radius:999px; font-size:.85rem; color:#fff }
  .bar{ height:4px; background:#1f2937 }
  .bar-in{ height:100%; background:linear-gradient(90deg,#22c55e,#f59e0b); width:0% }
  .empty{ border:1px dashed var(--line); border-radius:12px; padding:24px; color:var(--muted); text-align:center }

  /* Badge de siguiente episodio */
  .notify{
    display:inline-block; margin-left:8px; vertical-align:middle;
    padding:2px 8px; border-radius:999px; font-size:.78rem; font-weight:700; letter-spacing:.02rem;
    border:1px solid #14532d; color:#bbf7d0; background:rgba(34,197,94,.22);
  }
  .notify.upcoming{
    border-color:#7c2d12; color:#fed7aa; background:rgba(245,158,11,.22);
  }

  /* Estado VIENDO/TERMINADA */
  .state{
    position:absolute; top:8px; left:8px;
    padding:3px 8px; border-radius:999px; font-size:.78rem; font-weight:800; letter-spacing:.02rem;
    border:1px solid var(--line);
    background:rgba(0,0,0,.65); color:#fff;
  }
  .state.done{
    border-color:#14532d; background:rgba(34,197,94,.18); color:#bbf7d0;
  }

  /* ===== Nuevo dise√±o de modal compacto (modificado) ===== */
  .modal-back {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    display: none; align-items: center; justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
  }
  .modal {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    width: 360px;
    padding: 20px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.45);
    display: flex; flex-direction: column; gap: 14px;
    animation: popIn .25s ease;
  }
  @keyframes popIn {
    from {transform: scale(.85); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
  }
  .modal .top {
    display: flex; align-items: flex-start; gap: 14px;
  }
  .modal img {
    width: 100px; height: 150px;
    object-fit: cover; border-radius: 10px; border:1px solid var(--line);
  }
  .modal .meta h3 {
    margin: 0; font-size: 1.05rem;
  }
  .modal .meta .muted {
    color: var(--muted); font-size: .9rem; margin-bottom: 6px;
  }
  .modal .controls {
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  }
  .modal input.num {
    width: 50px; text-align: center;
  }
  .modal .bottom {
    display: flex; flex-direction: column; gap: 10px;
  }
  .modal button { border-radius: 8px; padding:8px 12px; }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="hero">
      <div class="badges">
        <div class="badge">SERIES</div>
        <div class="badge alt">WATCHLIST</div>
      </div>
      <div class="row">
        <div class="searchbox">
          <input id="q" type="text" placeholder="Buscar series‚Ä¶ (ej. Dark, Friends, The Office)" autocomplete="off"/>
          <div id="drop" class="dropdown"></div>
        </div>
        <button id="clear" class="btn-ghost">Limpiar</button>
        <button id="toggleFilter" class="btn-ghost">Ocultar terminadas</button>
      </div>
    </div>
  </div>
</header>

<main class="section">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No tienes series a√∫n. Busca arriba y agr√©galas üçø</div>
</main>

<div id="mb" class="modal-back">
  <div class="modal">
    <div class="top">
      <img id="mPoster" src="" alt="">
      <div class="meta">
        <h3 id="mTitle"></h3>
        <div class="muted" id="mInfo"></div>
        <div class="controls">
          <button id="mMinus">‚àí1</button>
          <input id="mCurr" class="num" type="number" min="0" />
          <button id="mPlus">+1</button>
          <span class="muted" id="mTotal"></span>
        </div>
        <div class="bar" style="margin-top:6px;"><div id="mBar" class="bar-in"></div></div>
      </div>
    </div>
    <div class="bottom">
      <div class="controls">
        <button id="mMarkDone" class="btn-ghost" style="border:1px solid var(--line)">Marcar como terminada</button>
        <button id="mReset" class="btn-ghost">Reiniciar (episodio 0)</button>
      </div>
      <div class="controls">
        <button id="mDelete" class="btn-ghost" style="color:#fca5a5;border-color:#7f1d1d">Eliminar</button>
        <button id="mClose" class="btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ===== FIREBASE INTEGRACI√ìN =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAQpxEWjV_J3AfyBDR4EWEmSrgFjW16z9k",
    authDomain: "series-80d83.firebaseapp.com",
    projectId: "series-80d83",
    storageBucket: "series-80d83.firebasestorage.app",
    messagingSenderId: "959880535049",
    appId: "1:959880535049:web:148625072c52de0acbacd8",
    measurementId: "G-7495M6CRN7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const coll = collection(db, "series_watchlist");

  /* ===== STORAGE FIREBASE ===== */
  const load = async () => {
    const snapshot = await getDocs(coll);
    const data = snapshot.docs.map(d => d.data());
    return data.sort((a,b)=>b.id.localeCompare(a.id)); // orden descendente por id
  };
  const save = async (data) => {
    for(const s of data){
      await setDoc(doc(coll, s.id), s);
    }
  };
  const deleteFromDB = async (id) => {
    await deleteDoc(doc(coll,id));
  };
  const getHideDone = () => JSON.parse(localStorage.getItem('series_hideDone') || 'false');
  const setHideDone = (v) => localStorage.setItem('series_hideDone', JSON.stringify(!!v));

  /* ===== RESTO DEL JS ORIGINAL ===== */
  let shows = await load();
  let results = [];
  let activeIndex = -1;
  let hideDone = getHideDone();

  const q = document.getElementById('q');
  const drop = document.getElementById('drop');
  const clearBtn = document.getElementById('clear');
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const toggleFilterBtn = document.getElementById('toggleFilter');

  const mb = document.getElementById('mb');
  const mPoster = document.getElementById('mPoster');
  const mTitle  = document.getElementById('mTitle');
  const mInfo   = document.getElementById('mInfo');
  const mCurr   = document.getElementById('mCurr');
  const mTotal  = document.getElementById('mTotal');
  const mBar    = document.getElementById('mBar');
  const mMinus  = document.getElementById('mMinus');
  const mPlus   = document.getElementById('mPlus');
  const mMarkDone = document.getElementById('mMarkDone');
  const mReset  = document.getElementById('mReset');
  const mDelete = document.getElementById('mDelete');
  const mClose  = document.getElementById('mClose');

  function updateFilterButton(){ toggleFilterBtn.textContent = hideDone ? 'Mostrar terminadas' : 'Ocultar terminadas'; }

  async function render() {
    grid.innerHTML = '';
    if (shows.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    const filtered = hideDone
      ? shows.filter(s => !((s.total || 0) > 0 && (s.curr || 0) >= s.total))
      : [...shows];

    const sorted = [...filtered].sort((a, b) => {
      const aDone = (a.total || 0) > 0 && (a.curr || 0) >= a.total;
      const bDone = (b.total || 0) > 0 && (b.curr || 0) >= b.total;
      if (aDone === bDone) return 0;
      return aDone ? 1 : -1;
    });

    for (const s of sorted) {
      const card = document.createElement('div');
      card.className = 'card';

      const imgEl = document.createElement('img');
      imgEl.className = 'poster';
      imgEl.src = s.poster || '';
      imgEl.alt = s.title;
      imgEl.onerror = () => { imgEl.style.display = 'none'; };

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = s.title;

      const badge = s.next ? document.createElement('span') : null;
      if (badge){
        badge.className = 'notify';
        badge.textContent = s.next;
        title.appendChild(badge);
      }

      card.appendChild(imgEl);
      card.appendChild(title);

      card.onclick = () => openModal(s);

      grid.appendChild(card);
    }
  }

  function openModal(show){
    mPoster.src = show.poster || '';
    mTitle.textContent = show.title;
    mInfo.textContent = `${show.year || ''} ‚Ä¢ ${show.type || ''}`;
    mCurr.value = show.curr || 0;
    mTotal.textContent = `de ${show.total || 0}`;
    const percent = show.total ? (show.curr || 0)/show.total*100 : 0;
    mBar.style.width = percent+'%';

    mMarkDone.textContent = (show.curr >= show.total) ? 'Desmarcar terminada' : 'Marcar como terminada';

    mb.style.display='flex';

    mMinus.onclick = async ()=>{ show.curr = Math.max(0,(show.curr||0)-1); await save(shows); render(); openModal(show); };
    mPlus.onclick = async ()=>{ show.curr = Math.min(show.total||(show.curr||0)+1,(show.curr||0)+1); await save(shows); render(); openModal(show); };
    mCurr.onchange = async ()=>{ show.curr = Number(mCurr.value); await save(shows); render(); openModal(show); };
    mMarkDone.onclick = async ()=>{
      if((show.curr||0) >= (show.total||0)){ show.curr = 0; } else { show.curr = show.total || 0; }
      await save(shows); render(); openModal(show);
    };
    mReset.onclick = async ()=>{ show.curr = 0; await save(shows); render(); openModal(show); };
    mDelete.onclick = async ()=>{ shows = shows.filter(s=>s.id!==show.id); await deleteFromDB(show.id); render(); mb.style.display='none'; };
    mClose.onclick = ()=>{ mb.style.display='none'; };
  }

  toggleFilterBtn.onclick = ()=>{ hideDone=!hideDone; setHideDone(hideDone); updateFilterButton(); render(); };
  clearBtn.onclick = async ()=>{ shows=[]; const snapshot = await getDocs(coll); for(const d of snapshot.docs){ await deleteFromDB(d.id); } render(); };

  updateFilterButton();
  render();

  // ===== BUSQUEDA TVMAZE =====
  async function search(query){
    if(!query) return drop.style.display='none';
    const res = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    results = data.map(d=>{
      const s = d.show;
      return {id:String(s.id), title:s.name, poster:s.image?.medium||'', total:s._embedded?.episodes?.length||0, curr:0, year: s.premiered?.split('-')[0]||'', type: s.type};
    });
    activeIndex=-1;
    renderDropdown();
  }

  function renderDropdown(){
    drop.innerHTML='';
    if(!results.length){ drop.style.display='none'; return; }
    results.forEach((r,i)=>{
      const el = document.createElement('div');
      el.className='opt'+(i===activeIndex?' active':'');
      el.innerHTML=`<div class="mini"><img src="${r.poster}" onerror="this.style.display='none'"></div>
                      <div><div class="t">${r.title}</div><div class="s">${r.year}</div></div>`;
      el.onclick=async ()=>{
        if(shows.find(s=>s.id===r.id)){ alert('Ya est√° en tu lista'); return; }
        shows.unshift({...r});
        await save(shows);
        render();
        drop.style.display='none';
        q.value='';
      };
      drop.appendChild(el);
    });
    drop.style.display='block';
  }

  let debounceTimer=null;
  q.oninput=()=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>search(q.value),300); };
  q.onkeydown=(e)=>{
    if(!results.length) return;
    if(e.key==='ArrowDown'){ activeIndex=(activeIndex+1)%results.length; renderDropdown(); e.preventDefault(); }
    if(e.key==='ArrowUp'){ activeIndex=(activeIndex-1+results.length)%results.length; renderDropdown(); e.preventDefault(); }
    if(e.key==='Enter' && activeIndex>=0){ results[activeIndex].onclick?.(); e.preventDefault(); }
  };

</script>
</body>
</html>
