<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SERIES ‚Äî Watchlist</title>

<style>
  :root{
    --bg:#0b0f19; --panel:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#e50914; --accent-2:#b81d24; --ok:#22c55e; --warn:#f59e0b; --line:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 400px at 50% -80px,rgba(229,9,20,.18),transparent 60%), var(--bg);
    color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,rgba(11,15,25,.96),rgba(11,15,25,.75));
    border-bottom:1px solid var(--line);
    backdrop-filter:blur(10px);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:20px 16px}
  .hero{ display:flex; flex-direction:column; gap:14px; align-items:center; justify-content:center; padding:18px 0 8px 0; }
  .badges{ display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; transform:translateZ(0); }
  .badge{
    font-family:'Cinzel', serif; font-weight:900; letter-spacing:.2rem;
    font-size: clamp(1.6rem, 3vw, 2.2rem); line-height:1;
    color:#fff; padding:8px 18px; border-radius:10px; border:1px solid #4c0b0f;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    text-shadow:0 1px 2px rgba(0,0,0,.6);
    box-shadow: 0 6px 20px rgba(229,9,20,.18), inset 0 0 12px rgba(255,255,255,.08);
    transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .badge.alt{ background:linear-gradient(90deg,var(--accent-2),var(--accent)); }
  .badge:hover{ transform:translateY(-2px) scale(1.03); filter:brightness(1.06); box-shadow:0 16px 36px rgba(229,9,20,.25), inset 0 0 12px rgba(255,255,255,.08); }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:10px; }
  input,button{ padding:12px 14px; border-radius:10px; border:1px solid var(--line); background:#0c1222; color:var(--text); }
  button{ cursor:pointer; transition:.2s ease }
  .btn-ghost{ background:transparent }

  /* Buscador grande */
  .searchbox{
    position:relative; flex:1;
    min-width:400px;
    max-width:900px;
  }
  .searchbox input{
    width:100%;
    height:60px;
    font-size:1.2rem;
    padding:14px 18px;
    border-radius:12px;
  }

  /* Dropdown */
  .dropdown{
    position:absolute; top:110%; left:0; right:0; background:#0b1220; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 14px 40px rgba(0,0,0,.45); max-height:480px; overflow:auto; display:none; padding:6px;
  }
  .opt{
    display:grid; grid-template-columns:68px 1fr; gap:12px;
    padding:10px; border-bottom:1px solid #111827; align-items:center; cursor:pointer; border-radius:8px;
  }
  .opt:hover{ background:#0f172a }
  .opt.active{ outline:2px solid rgba(229,9,20,.5); background:#0f172a; }
  .mini{
    width:68px; height:102px; border-radius:8px; border:1px solid var(--line); background:#111827; object-fit:cover; display:block;
  }
  .mini.placeholder{
    display:flex; align-items:center; justify-content:center; font-size:.75rem; color:#666; background:linear-gradient(180deg,#0f172a,#0b1220);
  }
  .opt .t{ font-weight:700; font-size:1.02rem; line-height:1.25; }
  .opt .s{ color:var(--muted); font-size:.95rem; margin-top:2px; }
  .opt mark{ background:rgba(229,9,20,.28); color:#fff; padding:0 .1em; border-radius:3px; }

  /* Grid */
  .section{ max-width:1200px; margin:18px auto; padding:0 16px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); gap:16px }
  .card{
    position:relative; background:var(--card); border:1px solid var(--line);
    border-radius:12px; overflow:hidden; cursor:pointer;
    transform:translateZ(0); transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .card:hover{ transform:translateY(-3px) scale(1.03); box-shadow:0 16px 36px rgba(0,0,0,.35); filter:brightness(1.03); }
  .poster{ width:100%; aspect-ratio:2/3; object-fit:cover; background:#101623; display:block }
  .title{
    position:absolute; left:8px; right:8px; bottom:8px;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,.88));
    padding:40px 10px 10px; border-radius:10px; color:#fff; font-weight:800;
    text-shadow:0 1px 2px rgba(0,0,0,.8); font-family:'Cinzel', serif; letter-spacing:.03rem; font-size:1rem; line-height:1.25;
    display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden;
  }
  .progress{ position:absolute; top:8px; right:8px; background:rgba(0,0,0,.65); border:1px solid var(--line); padding:3px 8px; border-radius:999px; font-size:.85rem; color:#fff }
  .bar{ height:4px; background:#1f2937 }
  .bar-in{ height:100%; background:linear-gradient(90deg,#22c55e,#f59e0b); width:0% }
  .empty{ border:1px dashed var(--line); border-radius:12px; padding:24px; color:var(--muted); text-align:center }

  /* Badge de siguiente episodio */
  .notify{
    display:inline-block; margin-left:8px; vertical-align:middle;
    padding:2px 8px; border-radius:999px; font-size:.78rem; font-weight:700; letter-spacing:.02rem;
    border:1px solid #14532d; color:#bbf7d0; background:rgba(34,197,94,.22);
  }
  .notify.upcoming{
    border-color:#7c2d12; color:#fed7aa; background:rgba(245,158,11,.22);
  }

  /* Estado VIENDO/TERMINADA */
  .state{
    position:absolute; top:8px; left:8px;
    padding:3px 8px; border-radius:999px; font-size:.78rem; font-weight:800; letter-spacing:.02rem;
    border:1px solid var(--line);
    background:rgba(0,0,0,.65); color:#fff;
  }
  .state.done{
    border-color:#14532d; background:rgba(34,197,94,.18); color:#bbf7d0;
  }

  /* Modal */
  .modal-back {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    display: none; align-items: center; justify-content: center;
    z-index: 100; backdrop-filter: blur(4px);
  }
  .modal {
    background: var(--panel); border: 1px solid var(--line); border-radius: 16px;
    width: 360px; padding: 20px; box-shadow: 0 8px 40px rgba(0,0,0,0.45);
    display: flex; flex-direction: column; gap: 14px; animation: popIn .25s ease;
  }
  @keyframes popIn { from {transform: scale(.85); opacity: 0;} to {transform: scale(1); opacity: 1;} }
  .modal .top { display: flex; align-items: flex-start; gap: 14px; }
  .modal img { width: 100px; height: 150px; object-fit: cover; border-radius: 10px; border:1px solid var(--line); }
  .modal .meta h3 { margin: 0; font-size: 1.05rem; }
  .modal .meta .muted { color: var(--muted); font-size: .9rem; margin-bottom: 6px; }

  /* ====== CONTROLES DEL MODAL (ajustes para que se vea el n√∫mero) ====== */
  .modal .controls {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .modal input.num {
    width: 72px;                 /* m√°s ancho para que quepa el valor */
    text-align: center;
    font-size: 1rem;             /* m√°s grande y legible */
    line-height: 1.2;            /* evita recorte vertical */
    padding: 8px 10px;           /* no queda ‚Äúaplastado‚Äù */
    z-index: 1;                  /* por encima de botones */
    position: relative;
    appearance: textfield;       /* oculta estilo nativo en la mayor√≠a */
    -moz-appearance: textfield;  /* Firefox */
    background:#0c1222;
    color: var(--text);
    border:1px solid var(--line);
    border-radius: 8px;
  }
  /* Quitar spinners WebKit */
  .modal input.num::-webkit-outer-spin-button,
  .modal input.num::-webkit-inner-spin-button{
    -webkit-appearance: none; margin: 0;
  }

  .modal .bottom { display: flex; flex-direction: column; gap: 10px; }
  .modal button { border-radius: 8px; padding:8px 12px; }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="hero">
      <div class="badges">
        <div class="badge">SERIES</div>
        <div class="badge alt">WATCHLIST</div>
      </div>
      <div class="row">
        <div class="searchbox">
          <input id="q" type="text" placeholder="Buscar series‚Ä¶ (ej. Dark, Friends, The Office)" autocomplete="off"/>
          <div id="drop" class="dropdown"></div>
        </div>
        <button id="clear" class="btn-ghost">Limpiar</button>
        <button id="toggleFilter" class="btn-ghost">Ocultar terminadas</button>
      </div>
    </div>
  </div>
</header>

<main class="section">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No tienes series a√∫n. Busca arriba y agr√©galas üçø</div>
</main>

<!-- Modal -->
<div id="mb" class="modal-back">
  <div class="modal">
    <div class="top">
      <img id="mPoster" src="" alt="">
      <div class="meta">
        <h3 id="mTitle"></h3>
        <div class="muted" id="mInfo">Progreso de episodios</div>
        <div class="controls">
          <button id="mMinus">‚àí1</button>
          <input id="mCurr" class="num" type="number" min="0" />
          <button id="mPlus">+1</button>
          <span class="muted" id="mTotal"></span>
        </div>
        <div class="bar" style="margin-top:6px;"><div id="mBar" class="bar-in"></div></div>
      </div>
    </div>
    <div class="bottom">
      <div class="controls">
        <button id="mMarkDone" class="btn-ghost" style="border:1px solid var(--line)">Marcar como terminada</button>
        <button id="mReset" class="btn-ghost">Reiniciar (episodio 0)</button>
      </div>
      <div class="controls">
        <button id="mDelete" class="btn-ghost" style="color:#fca5a5;border-color:#7f1d1d">Eliminar</button>
        <button id="mClose" class="btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK (Compat) + Init -->
https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js</script>
https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js</script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAQpxEWjV_J3AfyBDR4EWEmSrgFjW16z9k",
    authDomain: "series-80d83.firebaseapp.com",
    projectId: "series-80d83",
    storageBucket: "series-80d83.firebasestorage.app",
    messagingSenderId: "959880535049",
    appId: "1:959880535049:web:148625072c52de0acbacd8",
    measurementId: "G-7495M6CRN7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const coll = db.collection('series_watchlist');
</script>

<script>
  /* ===== STORAGE (Firebase) ===== */
  const KEY = 'series_watchlist_tvmaze_v3'; // compat

  const load = () => {
    setTimeout(async () => {
      try {
        const snap = await coll.get();
        const data = snap.docs.map(d => d.data()).sort((a,b) => b.id.localeCompare(a.id));
        shows = data.map(s => ({ next: null, checkedAt: 0, curr: 0, total: 0, poster:'', title:'', ...s }));
        updateFilterButton();
        render();
        refreshAllNext(true);
      } catch (e) { console.error('Firebase load error:', e); }
    }, 0);
    return [];
  };

  const save = (data) => {
    (async () => {
      const batch = db.batch();
      const ids = new Set();
      data.forEach(s => { if (!s || !s.id) return; ids.add(s.id); batch.set(coll.doc(s.id), s, { merge: true }); });
      await batch.commit();
      const snap = await coll.get();
      const toDelete = snap.docs.filter(d => !ids.has(d.id));
      if (toDelete.length) {
        const delBatch = db.batch();
        toDelete.forEach(d => delBatch.delete(d.ref));
        await delBatch.commit();
      }
    })().catch(e => console.error('Firebase save error:', e));
  };

  const getHideDone = () => JSON.parse(localStorage.getItem('series_hideDone') || 'false');
  const setHideDone = (v) => localStorage.setItem('series_hideDone', JSON.stringify(!!v));

  /* ===== STATE ===== */
  let shows = load();
  let results = [];
  let activeIndex = -1;
  let hideDone = getHideDone();

  /* ===== DOM ===== */
  const q = document.getElementById('q');
  const drop = document.getElementById('drop');
  const clearBtn = document.getElementById('clear');
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const toggleFilterBtn = document.getElementById('toggleFilter');

  // Modal
  const mb = document.getElementById('mb');
  const mPoster = document.getElementById('mPoster');
  const mTitle  = document.getElementById('mTitle');
  const mInfo   = document.getElementById('mInfo');
  const mCurr   = document.getElementById('mCurr');
  const mTotal  = document.getElementById('mTotal');
  const mBar    = document.getElementById('mBar');
  const mMinus  = document.getElementById('mMinus');
  const mPlus   = document.getElementById('mPlus');
  const mMarkDone = document.getElementById('mMarkDone');
  const mReset  = document.getElementById('mReset');
  const mDelete = document.getElementById('mDelete');
  const mClose  = document.getElementById('mClose');

  function updateFilterButton(){
    toggleFilterBtn.textContent = hideDone ? 'Mostrar terminadas' : 'Ocultar terminadas';
  }

  /* ===== HELPERS: Pr√≥ximo episodio (TVMaze) ===== */
  function buildNotifyBadge(s){
    if (!s.next) return null;
    const span = document.createElement('span');
    if (s.next.available) {
      span.className = 'notify';
      span.textContent = `E${s.next.num} DISPONIBLE`;
    } else {
      span.className = 'notify upcoming';
      const label = s.next.airDate
        ? new Date(s.next.airDate).toLocaleDateString(undefined, {month:'short', day:'2-digit'})
        : 'pronto';
      span.textContent = `E${s.next.num} ¬∑ ${label}`;
    }
    return span;
  }
  function shouldCheck(s){
    const SIX_HOURS = 6 * 60 * 60 * 1000;
    return !s.checkedAt || (Date.now() - s.checkedAt) > SIX_HOURS;
  }
  async function lazyUpdateNext(s){
    if (!s || !s.tvmaze_id) return;
    if (!shouldCheck(s)) return;
    try{
      const resp = await fetch(`https://api.tvmaze.com/shows/${s.tvmaze_id}/episodes`);
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const eps = await resp.json();

      const nextIdx = s.curr || 0; // 0-based
      let next = null;

      if (Array.isArray(eps) && eps.length > nextIdx){
        const nx = eps[nextIdx];
        const airStamp = nx.airstamp ? Date.parse(nx.airstamp) : null; // UTC
        const airDate = nx.airdate || null;
        const available = airStamp ? (Date.now() >= airStamp) : !!(airDate && Date.parse(airDate));
        next = { num: (s.curr || 0) + 1, title: nx.name || '', airStamp, airDate, available };
      } else {
        next = null;
      }

      s.total = Array.isArray(eps) ? eps.length : (s.total || 0);
      s.next = next;
      s.checkedAt = Date.now();
      save(shows);
      render();
    }catch(e){
      s.checkedAt = Date.now();
      save(shows);
    }
  }
  async function refreshAllNext(force=false){
    for (const s of shows || []){
      if (force) s.checkedAt = 0;
      await lazyUpdateNext(s);
    }
  }

  /* ===== RENDER GRID ===== */
  function render() {
    grid.innerHTML = '';
    if (!shows || shows.length === 0) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    const filtered = hideDone
      ? shows.filter(s => !((s.total || 0) > 0 && (s.curr || 0) >= s.total))
      : [...shows];

    const sorted = [...filtered].sort((a, b) => {
      const aDone = (a.total || 0) > 0 && (a.curr || 0) >= a.total;
      const bDone = (b.total || 0) > 0 && (b.curr || 0) >= b.total;
      if (aDone === bDone) return 0;
      return aDone ? 1 : -1;
    });

    for (const s of sorted) {
      const card = document.createElement('div');
      card.className = 'card';

      const imgEl = document.createElement('img');
      imgEl.className = 'poster';
      imgEl.src = s.poster || '';
      imgEl.alt = s.title;
      imgEl.onerror = () => { imgEl.style.display = 'none'; };

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = s.title;

      const badge = buildNotifyBadge(s);
      if (badge) title.appendChild(badge);

      const isDone = (s.total || 0) > 0 && (s.curr || 0) >= s.total;
      const state = document.createElement('div');
      state.className = 'state' + (isDone ? ' done' : '');
      state.textContent = isDone ? 'TERMINADA' : 'VIENDO';

      const prog = document.createElement('div');
      prog.className = 'progress';
      prog.textContent = `E ${s.curr || 0}/${s.total || 0}`;

      const bar = document.createElement('div');
      bar.className = 'bar';
      const barIn = document.createElement('div');
      barIn.className = 'bar-in';
      const pct = s.total ? Math.min(100, Math.round(100 * (s.curr||0) / s.total)) : 0;
      barIn.style.width = pct + '%';
      bar.appendChild(barIn);

      card.append(imgEl, title, prog, bar, state);
      card.onclick = () => openModal(s);
      grid.appendChild(card);

      lazyUpdateNext(s);
    }
  }

  /* ===== MODAL ===== */
  function openModal(show){
    mPoster.src = show.poster || '';
    mTitle.textContent = show.title;
    mInfo.textContent = 'Progreso de episodios';
    mCurr.value = show.curr || 0;
    mCurr.min = 0;
    mCurr.max = show.total || 0;
    mTotal.textContent = `/ de ${show.total || 0} episodios`;
    mBar.style.width = (show.total ? (100 * (show.curr||0) / show.total) : 0) + '%';
    mMarkDone.textContent = (show.curr >= (show.total||0)) ? 'Desmarcar terminada' : 'Marcar como terminada';
    mb.style.display='flex';

    const touch = async () => { save(shows); render(); openModal(show); };

    mMinus.onclick = async ()=>{
      show.curr = Math.max(0,(show.curr||0)-1);
      show.checkedAt = 0; show.next = null;
      await touch();
    };
    mPlus.onclick  = async ()=>{
      const limit = show.total || ((show.curr||0)+1);
      show.curr = Math.min(limit,(show.curr||0)+1);
      show.checkedAt = 0; show.next = null;
      await touch();
    };
    mCurr.onchange = async ()=>{
      show.curr = Math.max(0, Math.min(show.total||0, Number(mCurr.value||0)));
      show.checkedAt = 0; show.next = null;
      await touch();
    };
    mMarkDone.onclick = async ()=>{
      if((show.curr||0) >= (show.total||0)){ show.curr = 0; } else { show.curr = show.total || 0; }
      show.checkedAt = 0; show.next = null;
      await touch();
    };
    mReset.onclick = async ()=>{
      show.curr = 0;
      show.checkedAt = 0; show.next = null;
      await touch();
    };
    mDelete.onclick = async ()=>{
      shows = shows.filter(s=>s.id!==show.id);
      await save(shows);
      render();
      mb.style.display='none';
    };
    mClose.onclick = ()=>{ mb.style.display='none'; };
  }

  /* ===== BUSCADOR TVMAZE ===== */
  let timer = null;

  async function searchTVMaze(text){
    try{
      const resp = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(text)}`);
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const data = await resp.json();
      results = data.map(d => d.show);
      activeIndex = -1;
      renderDropdown(results, text);
    }catch(e){
      drop.innerHTML = `<div class="opt"><div class="t">Error: ${e.message}</div></div>`;
      drop.style.display = 'block';
    }
  }

  function highlight(text, query){
    if(!query) return escapeHtml(text);
    const q = query.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    return escapeHtml(text).replace(new RegExp(q, 'ig'), m => `<mark>${m}</mark>`);
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function renderDropdown(list, query){
    if (!list.length){
      drop.innerHTML = `<div class="opt"><div class="t">Sin resultados</div></div>`;
      drop.style.display = 'block'; return;
    }
    drop.innerHTML = '';
    list.slice(0,20).forEach((sh, idx)=>{
      const year = (sh.premiered||'').slice(0,4);
      const mini = sh.image && (sh.image.medium || sh.image.original);
      const network = (sh.network && sh.network.name) || (sh.webChannel && sh.webChannel.name) || '';
      const status  = sh.status || '';
      const row = document.createElement('div');
      row.className = 'opt';
      row.dataset.index = idx;

      let miniCol;
      if (mini){
        miniCol = document.createElement('img');
        miniCol.className = 'mini';
        miniCol.src = mini; miniCol.alt = sh.name || '';
        miniCol.onerror = () => { miniCol.replaceWith(makePlaceholder()); };
      } else miniCol = makePlaceholder();

      const textCol = document.createElement('div');
      textCol.innerHTML = `
        <div class="t">${highlight(sh.name||'', query)}</div>
        <div class="s">${year?year:''}${network?` ¬∑ ${escapeHtml(network)}`:''}${status?` ¬∑ ${escapeHtml(status)}`:''}</div>
      `;

      row.append(miniCol, textCol);
      row.onclick = async () => {
        drop.style.display = 'none';
        try{
          const resp = await fetch(`https://api.tvmaze.com/shows/${sh.id}/episodes`);
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const episodes = await resp.json();
          const total = Array.isArray(episodes) ? episodes.length : 0;

          const exists = shows.some(x => x.tvmaze_id === sh.id);
          if (exists){ alert('Ya est√° en tu lista'); return; }

          const poster = sh.image ? (sh.image.original || sh.image.medium) : '';
          const item = {
            id: crypto.randomUUID(),
            tvmaze_id: sh.id,
            title: sh.name || 'Sin t√≠tulo',
            poster,
            total,
            curr: 0,
            next: null,
            checkedAt: 0
          };
          shows.unshift(item);
          save(shows);
          render();
        }catch(e){
          alert('No se pudo agregar: '+e.message);
        }
      };
      drop.appendChild(row);
    });
    drop.style.display = 'block';
    updateActive();
  }

  function makePlaceholder(){ const div = document.createElement('div'); div.className = 'mini placeholder'; div.textContent = '‚Äî'; return div; }
  function updateActive(){ [...drop.children].forEach((el, i) => el.classList.toggle('active', i === activeIndex)); }

  q.addEventListener('keydown', (e)=>{
    if (drop.style.display !== 'block') return;
    const max = drop.children.length - 1;
    if (e.key === 'ArrowDown'){ e.preventDefault(); activeIndex = Math.min(max, activeIndex + 1); updateActive(); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIndex = Math.max(0, activeIndex - 1); updateActive(); }
    else if (e.key === 'Enter'){ e.preventDefault(); const idx = activeIndex >= 0 ? activeIndex : 0; drop.children[idx]?.click(); }
    else if (e.key === 'Escape'){ drop.style.display = 'none'; }
  });

  q.addEventListener('input', e=>{
    const t = e.target.value.trim();
    if(!t){ drop.style.display = 'none'; drop.innerHTML=''; results=[]; activeIndex=-1; return; }
    clearTimeout(timer); timer = setTimeout(()=>searchTVMaze(t), 300);
  });
  clearBtn.onclick = async ()=>{
    if (!confirm('¬øVaciar toda tu lista?')) return;
    shows = [];
    await save(shows);
    render();
  };
  document.addEventListener('click', e=>{ if (!e.target.closest('.searchbox')) drop.style.display = 'none'; });

  /* ===== FILTRO ===== */
  updateFilterButton();
  toggleFilterBtn.addEventListener('click', ()=>{
    hideDone = !hideDone;
    setHideDone(hideDone);
    updateFilterButton();
    render();
  });

  /* Init UI */
  render();

  /* Refresco de disponibilidad */
  refreshAllNext();
  setInterval(refreshAllNext, 6 * 60 * 60 * 1000);
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) refreshAllNext(); });
</script>
</body>
</html>
